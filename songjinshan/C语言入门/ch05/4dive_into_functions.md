# 5 深入理解函数

## 5.1 return语句

在有返回值的函数中，return语句的作用是体重整个函数的返回值，并结束当前函数返回到调用它的地方。在没有返回值的函数中也可以使用return语句，例如当检查到一个错误是提前结束当前函数的执行并返回：

```c
#include <stdio.h>

void print_logarithm(double x)
{
    if (x <= 0.0){
        printf("Positive numbers only, please.\n");
        return;
    }
    printf("The log of x is %f", log(x));
}    
```

这个函数首先检查参数想是否大于0，如果x不大于0就打印错误提示，然后提前结束函数的执行返回到调用者，只有当x大于0时才能求对数。在打印了对数结果之后到达函数体的末尾，自然地结束执行并返回。注意，使用数学函数log需要包含头文件math.h ， 由于x是浮点数，应该与同类型的数做比较，所以写成0.0

前面定义了一个检查奇偶性的函数，如果是奇数就打印x is odd，如果是偶数就打印x is even。事实上这个函数并不十分好用，**我们定义一个检查奇偶性的函数往往不是为了打印两个字符串就完了，而是为了根据奇偶性的不同分辨执行不同的后续动作。我们可以把它改成一个返回布尔值的函数：

```c
int is_even(int x)
{
    if (x % 2 == 0)
        return 1;
    else
        return 0;
}    
```

有人喜欢写成return(1); 这种形式也可以，表达式外面套括号表示改变运算符优先级，在这里不起任何作用。我们可以这样调用这个函数：

```c
int i = 19;
if (is_even(i)) {
    /* do something */
} else {
    /* do some other thing */
}
```

**返回布尔值的函数是一类非常有用的函数，在程序中通常充当控制表达式，函数名通常带有is或if等表示判断的词，这里函数也叫做谓词(Predicate)**。is_even这个函数写的有点啰嗦，x % 2 这个表达式本来就有0值或非0值，直接把这个值单做布尔值返回就可以了：

```c
int is_even(int x)
{
	return !(x % 2);
}    
```

函数的返回值应该这样理解：**函数返回一个值相当于定义一个和返回值类型相同的临时变量并用return后面的表达式来初始化**。例如上面的函数调用相当于这样的过程：

```C
int 临时变量 = !(x % 2);
函数退出，局部变量x的存储空间释放;
if (临时变量) { /* 临时变量用完就释放*/
    /* do some thing */
} else {
    /* do some other thing */
}
```

当if语句对函数的返回值做判断时，函数已经退出，局部变量x已经释放，所以不可能在这时候才计算表达式!(x % 2)的值，表达式的值必然是事先计算好了存在一个临时变量里的，然后函数退出，局部变量释放，if语句对这个临时变量的值做判断。注意，**虽然函数的返回值可以看作是一个临时变量，但我们只是读一下的它的值，读完就释放它，而不能往它里面存新的值，换句话说，函数的返回值不是左值，或者说函数调用表达式不能做左值**，因此线面的复制语句是非法的：

```c 
is_even(20) = 1;
```

前面讲过，C语言的传参规则是Cal by Value，按值传递，现在我们直到返回值也是 按值传递的，即便返回语句写成return x; ，返回的也是变量x的值，而非变量x本身，因为变量x马上就要被释放了。

在写带有return语句的函数时要小心检查所有的代码路径(Code Path)。有些代码路径在任何条件下都执行不到，这称为Dead Code。有Dead Code就一定有Bug，你写的每一行代码都是想让程序在某种情况下去执行的，你不可能故意写出一行用于不会被执行的代码，如果程序在任何情况下都不会去执行它，说明跟你 预想的不一样，要么是i对所有可能的清理分析的不正确，也就是逻辑错误，要么就是笔误，语义错误。还有一些时候，对程序中所有可能的情况分析得不够全面将导致漏掉一些代码路径。如：

```c 
int absolute_value(int x)
{
    if (x < 0) {
        return -x;
    } else if (x > 0) {
        return x;
    }
}    
```

这个函数 被定义为返回int,就应该在任何情况下都返回int , 但上面这个程序在x==0时安静地退出函数，什么也不返回，C语言对于这种情况会返回什么结果是未定义的，通常返回不确定的值，等学到"函数调用"就明白为什么了。另外注意这个例子中把-号当负号用而不是当减号用，事实上+号也可以这么用。正负号是单目运算符，而加减好是双目运算符，正负号的优先级和逻辑非运算相同，比加减的优先级要高。

上面的代码不会产生编译错误，编译器只做语法检查和最简单的语义检查，而不检查程序的逻辑。

